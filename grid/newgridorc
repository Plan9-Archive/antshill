#!/bin/rc
# user facing grid orchestration helper

if(! test -e /n/g/sto.in){
	echo no grid service found at /n/g >[2=1]
	exit
}
echo 'Commands: scores [searchstring] | spawn scorename | fetch [parameters provided by spawn]'
rfork
griduser=''
while (~ $1 -*){
	switch($1){
	case -u
		griduser=$2
		shift
	case -d
		reqdial=$2
		shift
	}
	shift
}

cat /n/g/sto.out &
catkill1=$apid
cat /n/g/sto.err &
catkill2=$apid
cat /n/g/cpu.out &
catkill3=$apid
cat /n/g/cpu.err &
catkill4=$apid

fn killcats{
	@{echo kill>/proc/$catkill1/ctl}
	@{echo kill>/proc/$catkill2/ctl}
	@{echo kill>/proc/$catkill3/ctl}
	@{echo kill>/proc/$catkill4/ctl}
}

while(usercmd=`{read}){
	switch($usercmd){
	case spawn*
#		echo $usercmd $griduser>>/n/g/sto.in
		echo tlsclient -a $reqdial /bin/echo $usercmd $griduser
		tlsclient -a $reqdial /bin/echo $usercmd $griduser
		sleep 1
		echo $griduser req >>/n/g/sto.in
	case cpulog
		echo log >>/n/g/cpu.in
	case exit
		killcats
		exit
	case *
		tlsclient -a $reqdial /bin/echo $usercmd
		sleep 1
		echo $griduser req >>/n/g/sto.in
	}
}
